-- Lebyss.xys V2 - discord.gg/kigjm65
-- Key: 1234

-- Проверка ключа
local Key = "QUAON-Exeu-58-ff-45k-582m"
local KeyInput = ""
local KeyVerified = false

local function CheckKey(input)
    if input == Key then
        KeyVerified = true
        print("Key verified successfully!")
        return true
    end
    return false
end

-- Основные переменные
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- Настройки
local Settings = {
    ESP = {
        Enabled = true,
        Boxes = true,
        Tracers = true,
        Names = true,
        Health = true,
        Weapon = true,
        Avatar = true,
        Rainbow = true,
        Color = Color3.fromRGB(255, 0, 0),
        RainbowSpeed = 0.5
    },
    Aimbot = {
        Enabled = true,
        TeamCheck = true,
        VisibleCheck = true,
        Smoothness = 0.2,
        KeyBind = Enum.UserInputType.MouseButton2,
        SilentAim = true,
        HitChance = 100,
        TargetPart = "Head"
    },
    Hitboxes = {
        Enabled = false,
        Scale = 1.2,
        Transparency = 0.5,
        Color = Color3.fromRGB(255, 0, 0)
    }
}

-- Таблицы для хранения данных
local ESPObjects = {}
local Hitboxes = {}
local Connections = {}

-- Оптимизированная функция для создания ESP
function CreateESP(player)
    if player == LocalPlayer then return end
    
    local DrawingObjects = {
        Box = Drawing.new("Square"),
        Tracer = Drawing.new("Line"),
        Name = Drawing.new("Text"),
        Health = Drawing.new("Text"),
        Weapon = Drawing.new("Text"),
        Avatar = Drawing.new("Circle")
    }
    
    ESPObjects[player] = DrawingObjects
    
    for _, obj in pairs(DrawingObjects) do
        obj.Visible = false
        obj.ZIndex = 2
    end
    
    DrawingObjects.Box.Thickness = 1
    DrawingObjects.Tracer.Thickness = 1
    DrawingObjects.Name.Size = 14
    DrawingObjects.Health.Size = 12
    DrawingObjects.Weapon.Size = 12
    DrawingObjects.Avatar.Thickness = 1
    DrawingObjects.Avatar.Radius = 15
    DrawingObjects.Avatar.NumSides = 12
    
    DrawingObjects.Name.Outline = false
    DrawingObjects.Health.Outline = false
    DrawingObjects.Weapon.Outline = false
end

-- Оптимизированная функция для обновления ESP
function UpdateESP()
    if not KeyVerified then return end
    
    for player, drawings in pairs(ESPObjects) do
        if not player or not player.Character then
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
            continue
        end
        
        local character = player.Character
        local humanoid = character:FindFirstChild("Humanoid")
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        local head = character:FindFirstChild("Head")
        
        if not humanoid or not humanoidRootPart or not head or humanoid.Health <= 0 then
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
            continue
        end
        
        local position, onScreen = Camera:WorldToViewportPoint(humanoidRootPart.Position)
        
        if not onScreen then
            for _, drawing in pairs(drawings) do
                drawing.Visible = false
            end
            continue
        end
        
        -- Радужный эффект
        local rainbowColor = Color3.fromHSV((tick() * Settings.ESP.RainbowSpeed) % 1, 1, 1)
        local color = Settings.ESP.Rainbow and rainbowColor or Settings.ESP.Color
        
        -- Бокс ESP
        if Settings.ESP.Enabled and Settings.ESP.Boxes then
            local scale = math.clamp(1 / position.Z * 2, 0.5, 2)
            local width = 50 * scale
            local height = 80 * scale
            protectedLoad('https://raw.githubusercontent.com/mainstreamed/amongus-hook/refs/heads/main/drawingfix.lua');
            drawings.Box.Size = Vector2.new(width, height)
            drawings.Box.Position = Vector2.new(position.X - width / 2, position.Y - height / 2)
            drawings.Box.Color = color
            drawings.Box.Visible = true
        else
            drawings.Box.Visible = false
        end
        
        -- Трейсеры
        if Settings.ESP.Enabled and Settings.ESP.Tracers then
            drawings.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
            drawings.Tracer.To = Vector2.new(position.X, position.Y + 30)
            drawings.Tracer.Color = color
            drawings.Tracer.Visible = true
        else
            drawings.Tracer.Visible = false
        end
        
        -- Имя игрока
        if Settings.ESP.Enabled and Settings.ESP.Names then
            drawings.Name.Text = player.Name
            drawings.Name.Position = Vector2.new(position.X, position.Y - 45)
            drawings.Name.Color = color
            drawings.Name.Visible = true
        else
            drawings.Name.Visible = false
        end
        
        -- ХП
        if Settings.ESP.Enabled and Settings.ESP.Health then
            local health = math.floor(humanoid.Health)
            local maxHealth = math.floor(humanoid.MaxHealth)
            drawings.Health.Text = "HP: " .. health .. "/" .. maxHealth
            drawings.Health.Position = Vector2.new(position.X, position.Y - 30)
            drawings.Health.Color = Color3.fromRGB(0, 255, 0)
            drawings.Health.Visible = true
        else
            drawings.Health.Visible = false
        end
        
        -- Оружие
        if Settings.ESP.Enabled and Settings.ESP.Weapon then
            local weapon = "Fists"
            for _, tool in ipairs(character:GetChildren()) do
                if tool:IsA("Tool") then
                    weapon = tool.Name
                    break
                end
            end
            drawings.Weapon.Text = weapon
            drawings.Weapon.Position = Vector2.new(position.X, position.Y - 15)
            drawings.Weapon.Color = Color3.fromRGB(255, 255, 0)
            drawings.Weapon.Visible = true
        else
            drawings.Weapon.Visible = false
        end
        
        -- Аватар
        if Settings.ESP.Enabled and Settings.ESP.Avatar then
            drawings.Avatar.Position = Vector2.new(position.X, position.Y - 60)
            drawings.Avatar.Color = rainbowColor
            drawings.Avatar.Visible = true
        else
            drawings.Avatar.Visible = false
        end
    end
end

-- Функция для создания хитбоксов
function CreateHitboxes(player)
    if player == LocalPlayer then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    Hitboxes[player] = {}
    
    for _, partName in ipairs({"Head", "UpperTorso", "LowerTorso"}) do
        local part = character:FindFirstChild(partName)
        if part then
            local box = Instance.new("BoxHandleAdornment")
            box.Name = "Hitbox"
            box.Adornee = part
            box.AlwaysOnTop = true
            box.ZIndex = 5
            box.Size = part.Size * Settings.Hitboxes.Scale
            box.Color3 = Settings.Hitboxes.Color
            box.Transparency = Settings.Hitboxes.Transparency
            box.Parent = part
            
            table.insert(Hitboxes[player], box)
        end
    end
end

-- Функция для удаления хитбоксов
function RemoveHitboxes(player)
    if Hitboxes[player] then
        for _, box in ipairs(Hitboxes[player]) do
            if box then
                box:Destroy()
            end
        end
        Hitboxes[player] = nil
    end
end

-- Функция для поиска цели для аимбота
function FindTarget()
    if not Settings.Aimbot.Enabled or not KeyVerified then return nil end
    
    local closestPlayer = nil
    local closestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Settings.Aimbot.TeamCheck and player.Team == LocalPlayer.Team then continue end
        
        local character = player.Character
        if not character then continue end
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then continue end
        
        local head = character:FindFirstChild("Head")
        if not head then continue end
        
        local screenPosition, onScreen = Camera:WorldToViewportPoint(head.Position)
        if not onScreen then continue end
        
        local mousePosition = Vector2.new(Mouse.X, Mouse.Y)
        local targetPosition = Vector2.new(screenPosition.X, screenPosition.Y)
        local distance = (mousePosition - targetPosition).Magnitude
        
        if distance < closestDistance then
            closestDistance = distance
            closestPlayer = player
        end
    end
    
    return closestPlayer
end

-- Функция для аимбота
function Aimbot()
    if not Settings.Aimbot.Enabled or not KeyVerified then return end
    
    local target = FindTarget()
    if not target or not target.Character then return end
    
    local targetPart = target.Character:FindFirstChild(Settings.Aimbot.TargetPart)
    if not targetPart then return end
    
    local cameraCFrame = Camera.CFrame
    local targetPosition = targetPart.Position
    
    local delta = (targetPosition - cameraCFrame.Position).Unit
    local smoothness = Settings.Aimbot.Smoothness
    
    local newLookVector = cameraCFrame.Position + delta:Lerp((targetPosition - cameraCFrame.Position).Unit, 1 - smoothness)
    Camera.CFrame = CFrame.new(cameraCFrame.Position, newLookVector)
end

-- Упрощенный Silent Aim
local function SetupSilentAim()
    if not Settings.Aimbot.SilentAim or not KeyVerified then return end
    
    local mt = getrawmetatable(game)
    local oldNamecall = mt.__namecall
    
    setreadonly(mt, false)
    
    mt.__namecall = newcclosure(function(self, ...)
        local args = {...}
        local method = getnamecallmethod()
        
        if Settings.Aimbot.Enabled and method:find("Ray") then
            local target = FindTarget()
            if target and target.Character and math.random(1, 100) <= Settings.Aimbot.HitChance then
                local targetPart = target.Character:FindFirstChild(Settings.Aimbot.TargetPart)
                if targetPart then
                    if method == "Raycast" then
                        args[2] = (targetPart.Position - args[1]).Unit * 1000
                    elseif method == "FindPartOnRay" then
                        args[1] = Ray.new(args[1].Origin, (targetPart.Position - args[1].Origin).Unit * 1000)
                    end
                end
            end
        end
        
        return oldNamecall(self, unpack(args))
    end)
    
    setreadonly(mt, true)
end

-- Основной цикл с оптимизацией
local lastUpdate = 0
table.insert(Connections, RunService.RenderStepped:Connect(function()
    if not KeyVerified then return end
    
    -- Оптимизация: обновляем ESP только каждые 0.1 секунды
    local currentTime = tick()
    if currentTime - lastUpdate > 0.1 then
        UpdateESP()
        lastUpdate = currentTime
    end
    
    -- Аимбот
    if Settings.Aimbot.Enabled and UserInputService:IsMouseButtonPressed(Settings.Aimbot.KeyBind) then
        Aimbot()
    end
end))

-- Обработка новых игроков
table.insert(Connections, Players.PlayerAdded:Connect(function(player)
    if not KeyVerified then return end
    task.wait(1) -- Задержка для стабильности
    CreateESP(player)
    if Settings.Hitboxes.Enabled then
        CreateHitboxes(player)
    end
end))

-- Обработка вышедших игроков
table.insert(Connections, Players.PlayerRemoving:Connect(function(player)
    if ESPObjects[player] then
        for _, drawing in pairs(ESPObjects[player]) do
            drawing:Remove()
        end
        ESPObjects[player] = nil
    end
    
    RemoveHitboxes(player)
end))

-- GUI
local function CreateGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "LebyssGUI"
    screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 300, 0, 400)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    title.Text = "Lebyss.xys V2"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    title.Parent = mainFrame
    
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Size = UDim2.new(1, 0, 1, -30)
    scrollFrame.Position = UDim2.new(0, 0, 0, 30)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.ScrollBarThickness = 4
    scrollFrame.Parent = mainFrame
    
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Parent = scrollFrame
    
    -- ESP Settings
    local espSection = Instance.new("TextLabel")
    espSection.Size = UDim2.new(1, -10, 0, 30)
    espSection.Position = UDim2.new(0, 5, 0, 5)
    espSection.BackgroundTransparency = 1
    espSection.Text = "ESP Settings"
    espSection.TextColor3 = Color3.fromRGB(255, 255, 255)
    espSection.Font = Enum.Font.SourceSansBold
    espSection.TextSize = 16
    espSection.Parent = scrollFrame
    
    local function CreateToggle(text, default, callback)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, -10, 0, 25)
        frame.BackgroundTransparency = 1
        frame.Parent = scrollFrame
        
        local toggle = Instance.new("TextButton")
        toggle.Size = UDim2.new(0, 20, 0, 20)
        toggle.Position = UDim2.new(0, 0, 0, 0)
        toggle.BackgroundColor3 = default and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
        toggle.Text = ""
        toggle.Parent = frame
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -25, 1, 0)
        label.Position = UDim2.new(0, 25, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.Font = Enum.Font.SourceSans
        label.TextSize = 14
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = frame
        
        toggle.MouseButton1Click:Connect(function()
            local newState = not (toggle.BackgroundColor3 == Color3.fromRGB(0, 255, 0))
            toggle.BackgroundColor3 = newState and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
            callback(newState)
        end)
        
        return toggle
    end
    
    CreateToggle("ESP Enabled", Settings.ESP.Enabled, function(state) Settings.ESP.Enabled = state end)
    CreateToggle("Boxes", Settings.ESP.Boxes, function(state) Settings.ESP.Boxes = state end)
    CreateToggle("Tracers", Settings.ESP.Tracers, function(state) Settings.ESP.Tracers = state end)
    CreateToggle("Names", Settings.ESP.Names, function(state) Settings.ESP.Names = state end)
    CreateToggle("Health", Settings.ESP.Health, function(state) Settings.ESP.Health = state end)
    CreateToggle("Weapon", Settings.ESP.Weapon, function(state) Settings.ESP.Weapon = state end)
    CreateToggle("Avatar", Settings.ESP.Avatar, function(state) Settings.ESP.Avatar = state end)
    CreateToggle("Rainbow", Settings.ESP.Rainbow, function(state) Settings.ESP.Rainbow = state end)
    
    -- Aimbot Settings
    local aimbotSection = Instance.new("TextLabel")
    aimbotSection.Size = UDim2.new(1, -10, 0, 30)
    aimbotSection.Position = UDim2.new(0, 5, 0, 5)
    aimbotSection.BackgroundTransparency = 1
    aimbotSection.Text = "Aimbot Settings"
    aimbotSection.TextColor3 = Color3.fromRGB(255, 255, 255)
    aimbotSection.Font = Enum.Font.SourceSansBold
    aimbotSection.TextSize = 16
    aimbotSection.Parent = scrollFrame
    
    CreateToggle("Aimbot Enabled", Settings.Aimbot.Enabled, function(state) 
        Settings.Aimbot.Enabled = state 
        if state and Settings.Aimbot.SilentAim then
            SetupSilentAim()
        end
    end)
    CreateToggle("Team Check", Settings.Aimbot.TeamCheck, function(state) Settings.Aimbot.TeamCheck = state end)
    CreateToggle("Silent Aim", Settings.Aimbot.SilentAim, function(state) 
        Settings.Aimbot.SilentAim = state 
        if state and Settings.Aimbot.Enabled then
            SetupSilentAim()
        end
    end)
    
    -- Hitboxes Settings
    local hitboxSection = Instance.new("TextLabel")
    hitboxSection.Size = UDim2.new(1, -10, 0, 30)
    hitboxSection.Position = UDim2.new(0, 5, 0, 5)
    hitboxSection.BackgroundTransparency = 1
    hitboxSection.Text = "Hitboxes Settings"
    hitboxSection.TextColor3 = Color3.fromRGB(255, 255, 255)
    hitboxSection.Font = Enum.Font.SourceSansBold
    hitboxSection.TextSize = 16
    hitboxSection.Parent = scrollFrame
    
    CreateToggle("Hitboxes Enabled", Settings.Hitboxes.Enabled, function(state)
        Settings.Hitboxes.Enabled = state
        if state then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    CreateHitboxes(player)
                end
            end
        else
            for player, boxes in pairs(Hitboxes) do
                RemoveHitboxes(player)
            end
        end
    end)
    
    return screenGui
end

-- Система ввода ключа
local KeyGUI = Instance.new("ScreenGui")
KeyGUI.Name = "KeySystem"
KeyGUI.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local KeyFrame = Instance.new("Frame")
KeyFrame.Size = UDim2.new(0, 300, 0, 150)
KeyFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
KeyFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
KeyFrame.Parent = KeyGUI

local KeyText = Instance.new("TextLabel")
KeyText.Size = UDim2.new(1, 0, 0, 30)
KeyText.Position = UDim2.new(0, 0, 0, 10)
KeyText.BackgroundTransparency = 1
KeyText.Text = "Введите ключ доступа:"
KeyText.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyText.Font = Enum.Font.SourceSans
KeyText.TextSize = 20
KeyText.Parent = KeyFrame

local KeyBox = Instance.new("TextBox")
KeyBox.Size = UDim2.new(0.8, 0, 0, 30)
KeyBox.Position = UDim2.new(0.1, 0, 0, 50)
KeyBox.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
KeyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyBox.Font = Enum.Font.SourceSans
KeyBox.TextSize = 18
KeyBox.Parent = KeyFrame

local SubmitButton = Instance.new("TextButton")
SubmitButton.Size = UDim2.new(0.6, 0, 0, 30)
SubmitButton.Position = UDim2.new(0.2, 0, 0, 90)
SubmitButton.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
SubmitButton.Text = "Подтвердить"
SubmitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SubmitButton.Font = Enum.Font.SourceSans
SubmitButton.TextSize = 18
SubmitButton.Parent = KeyFrame

SubmitButton.MouseButton1Click:Connect(function()
    if CheckKey(KeyBox.Text) then
        KeyGUI:Destroy()
        CreateGUI()
        SetupSilentAim()
        
        -- Инициализация для существующих игроков
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                CreateESP(player)
                if Settings.Hitboxes.Enabled then
                    CreateHitboxes(player)
                end
            end
        end
    else
        KeyBox.Text = "Неверный ключ!"
        task.wait(1)
        KeyBox.Text = ""
    end
end)

-- Функция очистки
local function Cleanup()
    for _, connection in ipairs(Connections) do
        connection:Disconnect()
    end
    
    for player, drawings in pairs(ESPObjects) do
        for _, drawing in pairs(drawings) do
            drawing:Remove()
        end
    end
    
    for player, boxes in pairs(Hitboxes) do
        for _, box in ipairs(boxes) do
            if box then
                box:Destroy()
            end
        end
    end
    
    if KeyGUI then
        KeyGUI:Destroy()
    end
end

-- Очистка при отключении скрипта
UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.End then
        Cleanup()
    end
end)
